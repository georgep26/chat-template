AWSTemplateFormatVersion: '2010-09-09'
Description: 'IAM Role for RAG Lambda Function Execution with Bedrock, Secrets Manager, and VPC Access'

Parameters:
  ProjectName:
    Type: String
    Default: 'chat-template'
    Description: 'Name of the project'
  
  Environment:
    Type: String
    Default: 'dev'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'Environment name'
  
  AWSRegion:
    Type: String
    Default: 'us-east-1'
    Description: 'AWS region'

Resources:
  # IAM Role for Lambda execution
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-lambda-execution-role'
      Description: 'IAM role for RAG Lambda function with Bedrock, Secrets Manager, RDS Data API, and VPC access'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        # Basic Lambda execution permissions (CloudWatch Logs)
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        # VPC access permissions (if Lambda is in VPC to access RDS)
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        # Bedrock permissions for LLM inference and Knowledge Bases
        - PolicyName: BedrockAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowBedrockInvoke
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:Converse
                  - bedrock:ConverseStream
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWSRegion}::foundation-model/*'
              - Sid: AllowKnowledgeBaseRetrieval
                Effect: Allow
                Action:
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWSRegion}:${AWS::AccountId}:knowledge-base/*'
        
        # Secrets Manager permissions for DB credentials
        - PolicyName: SecretsManagerAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowSecretsManagerRead
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource:
                  - !Sub 'arn:aws:secretsmanager:${AWSRegion}:${AWS::AccountId}:secret:${ProjectName}-*db-connection-${Environment}-*'
        
        # Optional: S3 permissions if config files are in S3
        - PolicyName: S3ConfigAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowS3ConfigRead
                Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub 'arn:aws:s3:::${ProjectName}-${Environment}-config/*'
              - Sid: AllowS3BucketList
                Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::${ProjectName}-${Environment}-config'
        
        # ECR permissions for Lambda to pull container images
        - PolicyName: ECRPullAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowECRGetToken
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: '*'
              - Sid: AllowECRPullImage
                Effect: Allow
                Action:
                  - ecr:BatchGetImage
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchCheckLayerAvailability
                Resource:
                  - !Sub 'arn:aws:ecr:${AWSRegion}:${AWS::AccountId}:repository/${ProjectName}-rag-lambda-${Environment}'
        
        # RDS Data API permissions for Aurora Data API access (allows Lambda outside VPC)
        - PolicyName: RDSDataApiAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowRDSDataApiExecute
                Effect: Allow
                Action:
                  - rds-data:ExecuteStatement
                  - rds-data:BatchExecuteStatement
                Resource:
                  - !Sub 'arn:aws:rds:${AWSRegion}:${AWS::AccountId}:cluster:${ProjectName}-light-db-cluster-${Environment}'
              - Sid: AllowRDSDataApiDescribe
                Effect: Allow
                Action:
                  - rds:DescribeDBClusters
                Resource:
                  - !Sub 'arn:aws:rds:${AWSRegion}:${AWS::AccountId}:cluster:${ProjectName}-light-db-cluster-${Environment}'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-lambda-execution-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

Outputs:
  RoleArn:
    Description: 'ARN of the Lambda execution role'
    Value: !GetAtt LambdaExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaExecutionRoleArn'
  
  RoleName:
    Description: 'Name of the Lambda execution role'
    Value: !Ref LambdaExecutionRole
    Export:
      Name: !Sub '${AWS::StackName}-LambdaExecutionRoleName'

