AWSTemplateFormatVersion: '2010-09-09'
Description: 'IAM Role for CLI access - Local development and administrative tasks'

Parameters:
  ProjectName:
    Type: String
    Default: 'chat-template'
    Description: 'Name of the project'

  Environment:
    Type: String
    Default: 'dev'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'Environment name'

  TrustedAccountId:
    Type: String
    Description: 'AWS Account ID that can assume this role (usually the same account)'
    Default: ''

Conditions:
  UseSameAccount: !Equals [!Ref TrustedAccountId, '']

Resources:
  CLIRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-cli-role'
      Description: 'IAM role for CLI access to manage and inspect project resources'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If
                - UseSameAccount
                - !Sub 'arn:aws:iam::${AWS::AccountId}:root'
                - !Sub 'arn:aws:iam::${TrustedAccountId}:root'
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CLIReadPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # CloudFormation: Read stack information
              - Sid: CloudFormationRead
                Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackEvents
                  - cloudformation:DescribeStackResource
                  - cloudformation:DescribeStackResources
                  - cloudformation:GetTemplate
                  - cloudformation:ListStackResources
                  - cloudformation:ListStacks
                Resource: !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ProjectName}-*-${Environment}*'

              # Lambda: Read and invoke
              - Sid: LambdaAccess
                Effect: Allow
                Action:
                  - lambda:GetFunction
                  - lambda:GetFunctionConfiguration
                  - lambda:InvokeFunction
                  - lambda:ListVersionsByFunction
                Resource: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ProjectName}-${Environment}-*'

              # RDS: Read and Data API access
              - Sid: RDSAccess
                Effect: Allow
                Action:
                  - rds:DescribeDBClusters
                  - rds:DescribeDBInstances
                  - rds-data:ExecuteStatement
                  - rds-data:BatchExecuteStatement
                Resource:
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:cluster:${ProjectName}-*-${Environment}*'
                  - !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${ProjectName}-*-${Environment}*'

              # Secrets Manager: Read secrets
              - Sid: SecretsManagerRead
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                  - secretsmanager:ListSecrets
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${ProjectName}-*-${Environment}-*'

              # S3: Read and write to project buckets
              - Sid: S3Access
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:aws:s3:::${ProjectName}-*-${Environment}'
                  - !Sub 'arn:aws:s3:::${ProjectName}-*-${Environment}/*'

              # Bedrock: Knowledge Base and model access
              - Sid: BedrockAccess
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:Converse
                  - bedrock:Retrieve
                  - bedrock:RetrieveAndGenerate
                  - bedrock:GetKnowledgeBase
                  - bedrock:ListKnowledgeBases
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/*'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'

              # CloudWatch Logs: Read logs
              - Sid: LogsRead
                Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:GetLogEvents
                  - logs:FilterLogEvents
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${ProjectName}-${Environment}-*:*'

              # ECR: Read repository info
              - Sid: ECRRead
                Effect: Allow
                Action:
                  - ecr:DescribeRepositories
                  - ecr:DescribeImages
                  - ecr:ListImages
                Resource: !Sub 'arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/rag-lambda-${Environment}'

              # STS: Get caller identity
              - Sid: STS
                Effect: Allow
                Action:
                  - sts:GetCallerIdentity
                Resource: '*'

      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-cli-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName

Outputs:
  RoleArn:
    Description: 'ARN of the CLI access role'
    Value: !GetAtt CLIRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CLIRoleArn'

  RoleName:
    Description: 'Name of the CLI access role'
    Value: !Ref CLIRole
    Export:
      Name: !Sub '${AWS::StackName}-CLIRoleName'
