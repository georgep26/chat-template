AWSTemplateFormatVersion: '2010-09-09'
Description: 'IAM Role for GitHub Actions OIDC Authentication - Evaluation Pipeline'

Parameters:
  ProjectName:
    Type: String
    Default: 'chat-template'
    Description: 'Name of the project'
  
  Environment:
    Type: String
    Default: 'dev'
    AllowedValues: ['dev', 'staging', 'prod']
    Description: 'Environment name'
  
  GitHubOrg:
    Type: String
    Description: 'GitHub organization or username (e.g., "myorg" or "username")'
  
  GitHubRepo:
    Type: String
    Description: 'GitHub repository name (e.g., "chat-template")'
  
  GitHubSourceBranch:
    Type: String
    Default: 'development'
    Description: 'GitHub source branch name for PRs (e.g., "development")'
  
  GitHubTargetBranch:
    Type: String
    Default: 'main'
    Description: 'GitHub target branch for PRs (default: main)'
  
  SecretsManagerPolicyArn:
    Type: String
    Description: 'ARN of the Secrets Manager managed policy'
  
  S3EvaluationPolicyArn:
    Type: String
    Description: 'ARN of the S3 evaluation managed policy'
  
  LambdaInvokePolicyArn:
    Type: String
    Default: ''
    Description: 'Optional: ARN of the Lambda invoke managed policy'
  
  BedrockEvaluationPolicyArn:
    Type: String
    Description: 'ARN of the Bedrock evaluation managed policy'
  
  OIDCProviderArn:
    Type: String
    Description: 'ARN of the GitHub OIDC identity provider. Create the provider first; see docs/oidc_github_identity_provider_setup.md.'

Resources:
  # IAM Role for GitHub Actions
  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-evals-github-actions-role'
      Description: 'IAM role for GitHub Actions to run evaluation pipeline via OIDC'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow PRs from source branch targeting the specified target branch
          - Effect: Allow
            Principal:
              Federated: !Ref OIDCProviderArn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
                token.actions.githubusercontent.com:head_ref: !Ref GitHubSourceBranch
                token.actions.githubusercontent.com:base_ref: !Ref GitHubTargetBranch
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub 'repo:${GitHubOrg}/${GitHubRepo}:*pull_request'
          # Allow workflow_dispatch / workflow_call from environments (staging, prod, production)
          - Effect: Allow
            Principal:
              Federated: !Ref OIDCProviderArn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub:
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:environment:staging*'
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:environment:prod*'
          # Allow workflow_dispatch from specific branches (development, main)
          - Effect: Allow
            Principal:
              Federated: !Ref OIDCProviderArn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub:
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:ref:refs/heads/development'
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:ref:refs/heads/main'
      ManagedPolicyArns:
        - !Ref SecretsManagerPolicyArn
        - !Ref S3EvaluationPolicyArn
        - !Ref BedrockEvaluationPolicyArn
        - !If
          - HasLambdaPolicy
          - !Ref LambdaInvokePolicyArn
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-evals-github-actions-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
        - Key: GitHubRepo
          Value: !Sub '${GitHubOrg}/${GitHubRepo}'

Conditions:
  HasLambdaPolicy: !Not [!Equals [!Ref LambdaInvokePolicyArn, '']]

Outputs:
  RoleArn:
    Description: 'ARN of the GitHub Actions IAM role'
    Value: !GetAtt GitHubActionsRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-GitHubActionsRoleArn'
  
  RoleName:
    Description: 'Name of the GitHub Actions IAM role'
    Value: !Ref GitHubActionsRole
    Export:
      Name: !Sub '${AWS::StackName}-GitHubActionsRoleName'
  
  OIDCProviderArn:
    Description: 'ARN of the GitHub OIDC provider (as supplied)'
    Value: !Ref OIDCProviderArn
    Export:
      Name: !Sub '${AWS::StackName}-OIDCProviderArn'

