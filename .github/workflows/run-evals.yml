name: Run Evaluations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run evals against (dev, staging, or prod)'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_branch_check:
        description: 'Skip branch check (allow running from any branch)'
        required: false
        default: 'false'
        type: boolean
      upload_to_main:
        description: 'Push eval results to evals/eval_outputs/<datetime> on main (e.g. after merge to main)'
        required: false
        default: 'false'
        type: boolean
  workflow_call:
    inputs:
      environment:
        description: 'Environment to run evals against (dev, staging, or prod)'
        required: true
        default: 'staging'
        type: string
      upload_to_main:
        description: 'Push eval results to evals/eval_outputs/<datetime> on main'
        required: false
        default: 'false'
        type: boolean

jobs:
  run-evals:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || github.event.inputs.environment || 'staging' }}
    permissions:
      id-token: write
      # write includes read; needed for "Push eval results to main" when upload_to_main is true
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR is from development branch
        id: check-branch
        run: |
          # For manual runs, check the skip_branch_check input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.skip_branch_check || inputs.skip_branch_check || 'false' }}" == "true" ]; then
              echo "Manual run with branch check skipped. Running evaluation."
              echo "skip=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # For pull requests, check if PR is from development branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_BRANCH="${{ github.head_ref }}"
            if [ "$PR_BRANCH" != "development" ]; then
              echo "PR is from branch '$PR_BRANCH', not 'development'. Skipping evaluation."
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "PR is from 'development' branch. Running evaluation."
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            # Manual run without skip flag - check current branch
            CURRENT_BRANCH="${{ github.ref_name }}"
            if [ "$CURRENT_BRANCH" != "development" ] && [ "$CURRENT_BRANCH" != "main" ]; then
              echo "Current branch '$CURRENT_BRANCH' is not 'development' or 'main'. Skipping evaluation."
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Running evaluation on branch '$CURRENT_BRANCH'."
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate run name for upload to main
        if: steps.check-branch.outputs.skip != 'true' && (inputs.upload_to_main == 'true' || github.event.inputs.upload_to_main == 'true')
        id: generate-run-name
        run: echo "run_name=$(date -u +%Y-%m-%dT%H-%M-%SZ)" >> $GITHUB_OUTPUT

      - name: Set up Miniconda
        if: steps.check-branch.outputs.skip != 'true'
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.11'
          environment-file: environment.yml
          activate-environment: chat-template-env

      - name: Verify conda environment
        if: steps.check-branch.outputs.skip != 'true'
        shell: bash -l {0}
        run: |
          conda info
          conda list

      - name: Configure AWS credentials
        if: steps.check-branch.outputs.skip != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_EVALS_ROLE_ARN }}
          aws-region: us-east-1
        env:
          AWS_REGION: us-east-1

      - name: Set PYTHONPATH
        if: steps.check-branch.outputs.skip != 'true'
        shell: bash -l {0}
        run: |
          echo "PYTHONPATH=${{ github.workspace }}:${{ github.workspace }}/src/rag_lambda:${{ github.workspace }}/src" >> $GITHUB_ENV

      - name: Run evaluation pipeline
        if: steps.check-branch.outputs.skip != 'true'
        shell: bash -l {0}
        env:
          EVALS_ENVIRONMENT: ${{ inputs.environment || github.event.inputs.environment || 'staging' }}
          EVAL_RUN_NAME: ${{ steps.generate-run-name.outputs.run_name }}
        run: |
          if [ -n "$EVAL_RUN_NAME" ]; then
            python evals/evals_pipeline.py --config evals/evals_config.yaml --notes "PR Evaluation" --environment "$EVALS_ENVIRONMENT" --run-name "$EVAL_RUN_NAME"
          else
            python evals/evals_pipeline.py --config evals/evals_config.yaml --notes "PR Evaluation" --environment "$EVALS_ENVIRONMENT"
          fi

      - name: Upload evaluation results
        if: steps.check-branch.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: eval-results
          path: evals/eval_outputs/
          retention-days: 7

      - name: Push eval results to main
        if: steps.check-branch.outputs.skip != 'true' && (inputs.upload_to_main == 'true' || github.event.inputs.upload_to_main == 'true')
        run: |
          RUN_NAME="${{ steps.generate-run-name.outputs.run_name }}"
          git fetch origin main
          git checkout main
          git pull origin main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "evals/eval_outputs/$RUN_NAME"
          git status
          if git diff --staged --quiet; then
            echo "No new eval outputs to commit."
          else
            git commit -m "chore(evals): add eval results $RUN_NAME [skip ci]"
            git push origin main
          fi

