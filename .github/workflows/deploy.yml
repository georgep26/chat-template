name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      s3_app_config_uri:
        description: 'S3 URI for app config file (e.g., s3://bucket/key)'
        required: true
        type: string
      local_app_config_path:
        description: 'Local app config file path (optional, will upload to S3)'
        required: false
        type: string
      master_password:
        description: 'Database master password (optional, required if DB does not exist)'
        required: false
        type: string
      region:
        description: 'AWS region'
        required: false
        default: 'us-east-1'
        type: string
      skip_network:
        description: 'Skip network deployment'
        required: false
        default: false
        type: boolean
      skip_s3:
        description: 'Skip S3 bucket deployment'
        required: false
        default: false
        type: boolean
      skip_db:
        description: 'Skip database deployment'
        required: false
        default: false
        type: boolean
      skip_kb:
        description: 'Skip knowledge base deployment'
        required: false
        default: false
        type: boolean
      skip_lambda:
        description: 'Skip Lambda deployment'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ inputs.region || 'us-east-1' }}
        env:
          AWS_REGION: ${{ inputs.region || 'us-east-1' }}

      - name: Validate inputs
        run: |
          if [ -z "${{ inputs.environment }}" ]; then
            echo "Error: environment is required"
            exit 1
          fi
          
          if [ "${{ inputs.skip_lambda }}" != "true" ] && [ -z "${{ inputs.s3_app_config_uri }}" ]; then
            echo "Error: s3_app_config_uri is required when deploying Lambda"
            exit 1
          fi
          
          echo "Deployment configuration:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Region: ${{ inputs.region || 'us-east-1' }}"
          echo "  S3 App Config URI: ${{ inputs.s3_app_config_uri }}"
          echo "  Local App Config Path: ${{ inputs.local_app_config_path || 'N/A' }}"
          echo "  Skip Network: ${{ inputs.skip_network }}"
          echo "  Skip S3: ${{ inputs.skip_s3 }}"
          echo "  Skip DB: ${{ inputs.skip_db }}"
          echo "  Skip KB: ${{ inputs.skip_kb }}"
          echo "  Skip Lambda: ${{ inputs.skip_lambda }}"

      - name: Build deployment command
        id: build-cmd
        run: |
          CMD="./scripts/deploy/deploy_all.sh ${{ inputs.environment }}"
          CMD="$CMD --s3-app-config-uri ${{ inputs.s3_app_config_uri }}"
          CMD="$CMD --region ${{ inputs.region || 'us-east-1' }}"
          
          if [ -n "${{ inputs.local_app_config_path }}" ]; then
            CMD="$CMD --local-app-config-path ${{ inputs.local_app_config_path }}"
          fi
          
          if [ -n "${{ inputs.master_password }}" ]; then
            CMD="$CMD --master-password ${{ inputs.master_password }}"
          fi
          
          if [ "${{ inputs.skip_network }}" == "true" ]; then
            CMD="$CMD --skip-network"
          fi
          
          if [ "${{ inputs.skip_s3 }}" == "true" ]; then
            CMD="$CMD --skip-s3"
          fi
          
          if [ "${{ inputs.skip_db }}" == "true" ]; then
            CMD="$CMD --skip-db"
          fi
          
          if [ "${{ inputs.skip_kb }}" == "true" ]; then
            CMD="$CMD --skip-kb"
          fi
          
          if [ "${{ inputs.skip_lambda }}" == "true" ]; then
            CMD="$CMD --skip-lambda"
          fi
          
          echo "command=$CMD" >> $GITHUB_OUTPUT
          echo "Deployment command: $CMD"

      - name: Run deployment
        id: deploy
        run: ${{ steps.build-cmd.outputs.command }}
        env:
          AWS_REGION: ${{ inputs.region || 'us-east-1' }}

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "✅ Deployment completed successfully!"
            echo "Environment: ${{ inputs.environment }}"
            echo "Region: ${{ inputs.region || 'us-east-1' }}"
          else
            echo "❌ Deployment failed. Check logs above for details."
            exit 1
          fi

