# Sensitive values are read from environment secrets (per-environment: dev/staging/prod).
# Set these in GitHub: Settings → Environments → <env> → Environment secrets.
# See docs/github_environment_secrets.md for secret names (S3_APP_CONFIG_URI, MASTER_DB_PASSWORD, etc.).
name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_network:
        description: 'Skip network deployment'
        required: false
        default: false
        type: boolean
      skip_s3:
        description: 'Skip S3 bucket deployment'
        required: false
        default: false
        type: boolean
      skip_db:
        description: 'Skip database deployment'
        required: false
        default: false
        type: boolean
      skip_kb:
        description: 'Skip knowledge base deployment'
        required: false
        default: false
        type: boolean
      skip_lambda:
        description: 'Skip Lambda deployment'
        required: false
        default: false
        type: boolean
      skip_cost_tags:
        description: 'Skip cost allocation tags activation'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOYER_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        env:
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Validate inputs
        run: |
          if [ -z "${{ inputs.environment }}" ]; then
            echo "Error: environment is required"
            exit 1
          fi
          
          if [ "${{ inputs.skip_lambda }}" != "true" ] && [ -z "${{ secrets.S3_APP_CONFIG_URI }}" ]; then
            echo "Error: S3_APP_CONFIG_URI secret is required when deploying Lambda"
            exit 1
          fi
          
          if [ "${{ inputs.skip_network }}" == "true" ] && [ "${{ inputs.skip_db }}" != "true" ]; then
            if [ -z "${{ secrets.VPC_ID }}" ] || [ -z "${{ secrets.SUBNET_IDS }}" ]; then
              echo "Error: VPC_ID and SUBNET_IDS secrets are required when skip_network is true and skip_db is false"
              exit 1
            fi
          fi
          
          echo "Validating deployment inputs..."

      - name: Build deployment command
        id: build-cmd
        env:
          S3_APP_CONFIG_URI: ${{ secrets.S3_APP_CONFIG_URI }}
          LOCAL_APP_CONFIG_PATH: ${{ secrets.LOCAL_APP_CONFIG_PATH }}
          MASTER_DB_PASSWORD: ${{ secrets.MASTER_DB_PASSWORD }}
          MASTER_DB_USERNAME: ${{ secrets.MASTER_DB_USERNAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          VPC_ID: ${{ secrets.VPC_ID }}
          SUBNET_IDS: ${{ secrets.SUBNET_IDS }}
          SECURITY_GROUP_IDS: ${{ secrets.SECURITY_GROUP_IDS }}
        run: |
          REGION="${AWS_REGION:-us-east-1}"
          CMD="./scripts/deploy/deploy_all.sh ${{ inputs.environment }}"
          if [ -n "$S3_APP_CONFIG_URI" ]; then
            CMD="$CMD --s3-app-config-uri $S3_APP_CONFIG_URI"
          fi
          CMD="$CMD --region $REGION"
          
          if [ -n "$LOCAL_APP_CONFIG_PATH" ]; then
            CMD="$CMD --local-app-config-path $LOCAL_APP_CONFIG_PATH"
          fi
          
          if [ -n "$MASTER_DB_USERNAME" ]; then
            CMD="$CMD --master-username $MASTER_DB_USERNAME"
          fi
          if [ -n "$MASTER_DB_PASSWORD" ]; then
            CMD="$CMD --master-password $MASTER_DB_PASSWORD"
          fi
          
          if [ "${{ inputs.skip_network }}" == "true" ]; then
            CMD="$CMD --skip-network"
          fi
          
          if [ "${{ inputs.skip_s3 }}" == "true" ]; then
            CMD="$CMD --skip-s3"
          fi
          
          if [ "${{ inputs.skip_db }}" == "true" ]; then
            CMD="$CMD --skip-db"
          fi
          
          if [ "${{ inputs.skip_kb }}" == "true" ]; then
            CMD="$CMD --skip-kb"
          fi
          
          if [ "${{ inputs.skip_lambda }}" == "true" ]; then
            CMD="$CMD --skip-lambda"
          fi
          
          if [ "${{ inputs.skip_cost_tags }}" == "true" ]; then
            CMD="$CMD --skip-cost-tags"
          fi
          
          if [ -n "$VPC_ID" ]; then
            CMD="$CMD --vpc-id $VPC_ID"
          fi
          if [ -n "$SUBNET_IDS" ]; then
            CMD="$CMD --subnet-ids $SUBNET_IDS"
          fi
          if [ -n "$SECURITY_GROUP_IDS" ]; then
            CMD="$CMD --security-group-ids $SECURITY_GROUP_IDS"
          fi
          
          echo "command<<EOF" >> $GITHUB_OUTPUT
          echo "$CMD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run deployment
        id: deploy
        run: ${{ steps.build-cmd.outputs.command }}
        env:
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed. Check logs above for details."
            exit 1
          fi

