name: Pull Request Workflow

# PRs from development → main: run all tests + evals, then deploy to staging.
# PRs to development: run tests and path-filtered evals only (no staging deploy).
on:
  pull_request:
    branches: [main, development]

permissions:
  checks: write
  pull-requests: write
  contents: read
  id-token: write
  statuses: write

jobs:
  run-tests:
    name: Run Tests
    uses: ./.github/workflows/test.yml
    secrets: inherit
    permissions:
      checks: write
      pull-requests: write
      contents: read

  # This job reports a simple status check that branch protection can require.
  # Reusable workflows don't properly report status checks for branch protection,
  # so we manually set a commit status after tests complete.
  # See: https://github.com/orgs/community/discussions/8512
  report-test-status:
    name: Report Test Status
    needs: [run-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Set commit status
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ needs.run-tests.result }}" == "success" ]; then
            STATE="success"
            DESC="Tests passed"
          else
            STATE="failure"
            DESC="Tests failed"
          fi
          
          gh api "/repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }}" \
            -f context="Run Tests" \
            -f state="$STATE" \
            -f description="$DESC" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  check-eval-paths:
    name: Check if evaluations needed
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.set-should-run.outputs.should-run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for relevant file changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            evals:
              - 'evals/**'
              - 'src/**'
              - 'data/**'
              - 'evals/evals_config.yaml'
              - '.github/workflows/run-evals.yml'

      # For PRs targeting main (development → main), always run evals. Otherwise use path filter.
      - name: Set whether to run evals
        id: set-should-run
        run: |
          if [ "${{ github.base_ref }}" == "main" ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=${{ steps.filter.outputs.evals }}" >> $GITHUB_OUTPUT
          fi

  run-evaluations:
    name: Run Evaluations
    needs: [run-tests, check-eval-paths]
    if: needs.check-eval-paths.outputs.should-run == 'true'
    uses: ./.github/workflows/run-evals.yml
    secrets: inherit
    permissions:
      id-token: write
      contents: read

  # Deploy to staging only for PRs from development → main, after tests and evals pass.
  deploy-staging-lambda:
    name: Deploy Lambda to Staging
    if: github.base_ref == 'main'
    needs: [run-tests, run-evaluations]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: staging
      skip_kb: true
      skip_ecr: true
      skip_lambda: false
    secrets: inherit

